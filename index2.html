<!doctype html>
<html ng-app>
<head>
	<title>KSP Optimal Rocket Calculator</title>
	<style type="text/css">

.form-control-minimal {
	border: none;
	background-color: transparent;
}

.input-group-addon.mathml {
	padding-top: 5px;
	padding-bottom: 5px;
}

.parts {
	overflow: auto;
	height: 55rem;
}

.partList .partList {
	padding-left: 24px;
}

	</style>
	<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.6/angular.min.js"></script>
	<script src="kspcalc.js"></script>
	<script type="text/javascript">

var bestStaging = null;
var bestStagingMetric = Infinity;
var bestStagingCount = 0;
var bestStagingArgs = null;
var bestStagingCallback = null;
var bestStagingCancel = function () {};
	
function onSearchResult(staging) {
	if (staging && staging.id === bestStagingArgs.id) {
		var stagingMetric = getMetric(staging, bestStagingArgs);
		bestStagingCount++;
		if (stagingMetric < bestStagingMetric) {
			bestStaging = staging;
			bestStagingMetric = stagingMetric;
			if (bestStagingCallback) bestStagingCallback(bestStaging);
		}
	}
}
	
var kspcalcWorkers;
if (typeof Worker !== "undefined") {
	try {
		kspcalcWorkers = [];
		//spawn 4 web workers
		for (var x = 0, xl = 4; x < xl; ++x) {
			kspcalcWorkers[x] = new Worker("kspcalc.js");
			kspcalcWorkers[x].addEventListener("message", function (evt) {
				onSearchResult(evt.data);
			});
		}
		bestStagingCancel = function () {
			for (var x = 0, xl = kspcalcWorkers.length; x < xl; ++x) {
				kspcalcWorkers[x].postMessage({cancel:true});
			}
		};
	} catch (e) {
		console.error("Failed to create web workers", e);
		kspcalcWorkers = null;
	}
}

function stopSearch() {
	bestStagingCancel();
}
	
function startSearch(args, callback) {
	stopSearch();
	
	args.id = Math.ceil(0xFFFFFFFF * Math.random());
	
	bestStaging = null;
	bestStagingMetric = Infinity;
	bestStagingCount = 0;
	bestStagingArgs = args;
	bestStagingCallback = callback;
	
	if (kspcalcWorkers) {
		for (var x = 0, xl = kspcalcWorkers.length; x < xl; ++x) {
			kspcalcWorkers[x].postMessage(args);
		}
	} else {
		bestStagingCancel = searchForOptimalStaging(args, onSearchResult);
	}
}
	
function SettingsController($scope) {
	//default settings
	$scope.optimization = "mass";
	$scope.payload = 1000;
	$scope.deltaV = 4600;
	$scope.planet = PLANETS[4];
	$scope.gravity = $scope.planet.gravity;
	$scope.twr = 1.2;
	$scope.stages = 1;
	$scope.parallel = false;
	$scope.asparagus = false;
	$scope.atmosphere = false;
	$scope.packTree = _.map(PACKS, function (pack) {
		var result = Object.create(pack);
		result.parts = _.map(_.groupBy(pack.parts, "type"), function (parts, partId) {
			return {
				name:TYPE_NAMES_PLURAL[partId],
				parts:parts
			}
		});
		return result;
	});
	$scope.searching = false;

	//constants
	$scope.PLANETS = PLANETS;
	$scope.PACKS = PACKS;
	$scope.TYPES = TYPES;
	$scope.TYPE_NAMES_PLURAL = TYPE_NAMES_PLURAL;
	
	//methods
	$scope.getEnabledParts = function () {
		var enabledParts = [];
		var packs = $scope.packTree;
		for (var x = 0, xl = packs.length; x < xl; ++x) {
			if (packs[x].enabled) {
				var types = packs[x].parts;
				for (var y = 0, yl = types.length; y < yl; ++y) {
					if (types[y].enabled) {
						var parts = types[y].parts
						for (var z = 0, zl = parts.length; z < zl; ++z) {
							if (parts[z].enabled) enabledParts.push(parts[z]);
						}
					}
				}
			}
		}
		return enabledParts;
	}
	$scope.search = function () {
		var args = {
			optimization : $scope.optimization,
			next : {payload:$scope.payload},
			deltaV : $scope.deltaV,
			planet : ($scope.planet ? $scope.planet : {gravity:$scope.gravity}),
			twr : $scope.twr,
			atm : ($scope.atmosphere ? 1 : 0),
			parallel : false,
			asparagus : false,
			stages : $scope.stages,
			stagesParallel : $scope.parallel || $scope.asparagus,
			stagesAsparagus : $scope.asparagus,
			parts : sortParts($scope.getEnabledParts())
		};
		
		startSearch(args, function (staging) {
			if (staging) {
				console.log(KSP.Stage.humanize(staging, args.planet, args.atm));
			}
		});
		$scope.searching = ($scope.stages > 1);
	}
	$scope.stop = function () {
		stopSearch();
		$scope.searching = false;
	};
	
	//event listeners
	$scope.onPlanetChange = function () {
		$scope.gravity = $scope.planet.gravity;
	};
	$scope.onGravityChange = function () {
		$scope.planet = null;
	};
	$scope.onAsparagusChange = function () {
		if ($scope.asparagus) $scope.stages = Math.max($scope.stages, 2);
	};
	$scope.onPartListItemChange = function (partListItem) {
		var parts = partListItem.parts;
		if (parts) {
			for (var x = 0, xl = parts.length; x < xl; ++x) {
				var part = parts[x];
				part.enabled = partListItem.enabled;
				$scope.onPartListItemChange(part);
			}
		}
		if (partListItem.enabled) {
			for (var x = 1, xl = arguments.length; x < xl; ++x) {
				arguments[x].enabled = true;
			}
		}
	};
	
	//initialization
	$scope.packTree[0].enabled = true;
	$scope.onPartListItemChange($scope.packTree[0]);
}

	</script>
</head>
<body>
	<div class="container">
		<div class="page-header">
			<h1>KSP Optimal Rocket Calculator</h1>
		</div>
		
		<div class="row" ng-controller="SettingsController">
			<div class="settings col-md-6">
				<div class="arguments form-horizontal">
					<div class="form-group">
						<label for="settingsOptimization" class="control-label col-sm-6">Optimize For</label>
						<div class="col-sm-6">
							<select name="optimization" id="settingsOptimization" class="form-control" ng-model="optimization">
								<option value="mass">Mass</option>
								<option value="cost">Cost</option>
							</select>
						</div>
					</div>
					
					<div class="form-group">
						<label for="settingsPayload" class="control-label col-sm-6">Payload</label>
						<div class="col-sm-6">
							<div class="input-group">
								<input type="number" name="payload" min="0" step="1" placeholder="0" id="settingsPayload" class="form-control" ng-model="payload"/>
								<span class="input-group-addon mathml"><math><mi>kg</mi></math></span>
							</div>
						</div>
					</div>
					
					<div class="form-group">
						<label for="settingsDeltaV" class="control-label col-sm-6">Minimum Delta-V</label>
						<div class="col-sm-6">
							<div class="input-group">
								<input type="number" name="deltaV" min="0" step="1" placeholder="0" id="settingsDeltaV" class="form-control" ng-model="deltaV"/>
								<span class="input-group-addon mathml"><math><mi>m</mi><mo>/</mo><msup><mi>s</mi><mn>2</mn></msup></math></span>
							</div>
						</div>
					</div>
					
					<div class="form-group">
						<label for="settingsPlanet" class="control-label col-sm-6">Local Gravity</label>
						<div class="col-sm-6">
							<div class="input-group">
								<span class="input-group-addon"><select name="planet" id="settingsPlanet" class="form-control-minimal" ng-model="planet" ng-options="PLANET as PLANET.name for PLANET in PLANETS" ng-change="onPlanetChange()"></select></span>
								<input type="number" name="gravity" min="0" step="0.001" id="settingsGravity" class="form-control" ng-model="gravity" ng-change="onGravityChange()"/>
								<span class="input-group-addon mathml"><math><mi>m</mi><mo>/</mo><msup><mi>s</mi><mn>2</mn></msup></math></span>
							</div>
						</div>
					</div>
					
					<div class="form-group">
						<label for="settingsTWR" class="control-label col-sm-6">Minimum Thrust-to-Weight Ratio</label>
						<div class="col-sm-6">
							<input type="number" name="twr" min="0" step="0.1" id="settingsTWR" class="form-control" ng-model="twr"/>
						</div>
					</div>
					
					<div class="form-group">
						<label for="settingsStages" class="control-label col-sm-6">Maximum # of Stages</label>
						<div class="col-sm-6">
							<input type="number" name="stages" min="1" step="1" id="settingsStages" class="form-control" ng-model="stages"/>
						</div>
					</div>
					
					<div class="form-group">
						<label class="control-label col-sm-6">Staging Setup</label>
						<div class="col-sm-6">
							<div class="checkbox">
								<label>
									<input type="checkbox" name="asparagus" id="settingsAsparagus" ng-model="asparagus" ng-change="onAsparagusChange()"/>
									Asparagus
								</label>
							</div>
						</div>
					</div>
					
					<div class="form-group">
						<label class="control-label col-sm-6">Options</label>
						<div class="col-sm-6">
							<div class="checkbox">
								<label>
									<input type="checkbox" name="atmosphere" id="settingsAtmosphere" ng-model="atmosphere"/>
									Use engine's atmospheric stats
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="parts col-md-6">
				<div class="partPacks partList">
					<div class="partPack partListItem checkbox" ng-repeat="pack in packTree">
						<input type="checkbox" ng-model="pack.enabled" ng-change="onPartListItemChange(pack)"/><span>{{pack.name}}</span>
						<div class="partTypes partList">
							<div class="partType partListItem" ng-repeat="type in pack.parts">
								<input type="checkbox" ng-model="type.enabled" ng-change="onPartListItemChange(type, pack)"/><span>{{type.name}}</span>
								<div class="partItems partList">
									<div class="partItem partListItem" ng-repeat="part in type.parts">
										<input type="checkbox" ng-model="part.enabled" ng-change="onPartListItemChange(part, type, pack)"/><span>{{part.name}}</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
			
		<div class="actions">
			<button class="btn btn-default" ng-click="search()">Search</button>
			<button class="btn btn-default" ng-click="stop()" ng-disabled="!searching">Stop</button>
		</div>
		
	</div>
</body>
</html>